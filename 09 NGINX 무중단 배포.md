# NGINX 무중단 배포      
배포를 진행하면 **새로운 Jar가 실행되기전까지 기존 Jar를 종료시켜 놓기 때문에**서비스가 중단됩니다.            
          
## 무중단 배포 소개        
배포가 서비스를 정지해야만 가능할 때는 롤백이 어렵고 서비스가 정지되니 곤혹스럽습니다.     
그래서 서비스를 중단시키지 않고 배포를 진행하는 **무중단 배포**를 해야합니다.    
  
* AWS에서 블루 그린 무중단 배포       
* 도커를 이용한 웹 서비스 무중단 배포     
  
이외에도 L4 스위치를 이용한 무중단 배포 방법도 있지만,   
L4가 워낙 고가의 장비이다 보니 대형 인터넷 기업외에는 쓸일이 거의 없습니다.    

**NGINX**는 웹 서버, 리버스 프록시, 캐싱, 로드 밸런싱, 미디어 스트리밍 등을 위한 오픈소스 소트프웨어입니다.   
**리버스 프록시**란 NGINX가 **외부의 요청을 받아 백앤드 서버로 요청을 전달하는 행위**를 합니다.        
리버스 프록시 서버(NGINX)는 요청을 전달하고, 실제 요청에 대한 처리는 뒷단의 웹 애플리케이션 서버들이 처리합니다.    
즉 NGINX 자체로도 서버로 이용이 가능하고 서버에 외부 요청을 전달하는 역할도 할 수 있습니다.          
또한 NGINX 는 AWS 서비스가 아니고 오픈소스 소프트웨어이기 때문에     
    
우리는 이 `리버스 프록시`를 사용하여 무중단 배포를 이용할 것입니다.       
**하나의 서버에 NGINX 1대와 스프링부트 Jar를 2대 사용하면 됩니다.**         

* NGINX 는 80번 포트, 443번 포트를 할당합니다.    
* 스프링부트1 은 8081 포트로 실행합니다.   
* 스프링부트2 는 8082 포트로 실행합니다.   
    
**앤진엑스 무중단 배포는 다음과 같은 구조가 됩니다.**
   
[사진]   
   
## 운영과정 

[사진]   
   
**최초 배포**
1. 사용자는 서비스 주소로 접속합니다. (**80 혹은 443 포트**)    
2. NGINX는 사용자의 요청을 받아 현재 연결된 스프링 부트1(8081)로 요청을 전달합니다.   
3. 현재 스프링 부트2(8081)는 NGINX와 연결된 상태가 아니니 요청받지 못합니다.   
     
[사진]        
        
**2번재 배포**    
1. 연결되지 않은 서버로 새로운 배포를 진행합니다.   
2. 배포하는 동안에도 기존 서비스는 중단되지 않습니다.(NGINX는 기존 최초 서버를 바라바보기 때문입니다.)      
3. 배포가 끝나면 스프링 부트2가 구동하기 시작합니다.   
4. NGINX 는 스프링 부트2가 구동 중인지 확인하고 구동 중이면 nginx reload 명령어를 통해 스프링부트2를 바라보도록합니다.    
5. nginx reload는 0.1초 이내로 완료되기에 딜레이가 없이 서버가 바뀌게 됩니다.   
   
[사진]    
   
**3번재 배포**    
1. 스프링 부트1로 배포를 진행합니다. 
2. 배포하는 동안에도 기존 서비스는 중단되지 않습니다.(NGINX는 스프링 부트2를 바라바보기 때문입니다.)      
3. 배포가 끝나면 스프링 부트1가 재구동하기 시작합니다.   
4. NGINX 는 스프링 부트1이 구동 중인지 확인하고 구동 중이면 nginx reload 명령어를 통해 스프링 부트1를 바라보도록합니다.    
5. nginx reload는 0.1초 이내로 완료되기에 딜레이가 없이 서버가 바뀌게 됩니다. 

[전체 구조]   
    
## 엔진엑스 설치와 스프링 부트 연동하기  
### 엔진엑스 설치 
1. EC2에 접속한 후 `sudo yum install nginx` 입력
2. 설치가 완료되었다면 `sudo service nginx start`로 nginx 실행  
3. NGINX가 잘 실행되었다면 `starting nginx: [ ok ]` 출력이 되므로 이를 확인   

### 보안 그룹 추가 
먼저 NGINX의 포트번호를 보안그룹에 추가해야합니다.    
NGINX의 기본적인 포트번호는 80이므로 EC2 보안그룹에 80번 트를 할당해줍시다.    

1. EC2 서비스로 이동     
2. 왼쪽 대시보드의 `[네트워크 보안 및 관리 카테고리]`에서 `[보안 그룹]`으로 이동    
3. EC2 관련 보안그룹을 클릭         
4. 인바운드 규칙에서 NGINX 관련 보안그룹 추가     

|유형|프로토콜|포트 범위|소스|설명-선택사항|
|---|---|---|---|---|
|HTTP|TCP|80|사용자 지정-0.0.0.0/0|NGINX|
|HTTP|TCP|80|사용자 지정-::/0|NGINX|

### 리다이렉션 추가   



 
