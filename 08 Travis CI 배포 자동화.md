08 Travis CI 배포 자동화
=======================
여러 개발자의 코드를 실시간으로 병합하고,     
테스트가 수행되는 환경, master 브랜치가 푸시되면 배포가 자동으로 이루어지는 환경을 구축해줍니다.      
   
# 1. CI & CD    
* CI : VCS(버전관리) 시스템 등에 PUSH가 되면 자동으로 테스트와 빌드가 수행되어 **안정적인 배포 파일을 만드는 과정**        
  * CI == 지속적인 통합        
* CD : 빌드 결과를 자동으로 운영 서버에 **무중단 배포까지 진행되는 과정**       
  * CD == 지속적인 배포      
   
일반적으로 CI만 구축되어 있지는 않고, CD도 함께 구축된 경우가 대부분입니다.     
   
**여기서 주의할 점은 단순히 CI 도구를 도입했다고 해서 CI를 하고 있는 것은 아닙니다.**     
마틴 파울러는 CI에 대해 다음과 같은 4가지 규칙을 이야기합니다. (http://bit.ly/2Yv0vFp)   
   
* 모든 소스 코드가 살아 있고(실행 되고) 누구든 현재의 소스에 접근할 수 있는 단일 지점을 유지할 것        
* 빌드 프로세스를 자동화해서 누구든 소스로부터 시스템을 빌드하는 단일 명령어를 사용할 수 있게 할 것         
* 테스팅을 자동화 해서 단일 명령어로 언제든지 시스템에 대한 건전한 테스트 수트를 실행할 수 있게 할 것     
* 누구나 현재 실행 파일을 얻으면 지금까지 가장 완전한 실행 파일을 얻었다는 확신을 하게 할 것     
     
여기서 특히나 중요한 것은 테스팅 자동화입니다.     
지속적으로 통합하기 위해서는 무엇보다 이 프로젝트가 완전한 **상태임을 보장**하기 위해 테스트 코드가 구현되어 있어야만 합니다.     
TDD 에 대한 전반적인 이해가 필요하신 분들은 ->      
https://www.youtube.com/watch?v=wmHV6L0e1sU&index=7&t=1538s&list=PLagTY0ogyVkIl2kTr08w-4MLGYWJz7lNK   
     
***
# 2. Travis CI 연동하기    
Travis CI는 깃허브에서 제공하는 무료 CI 서비스입니다.        
젠킨스와 같은 CI 도구도 있지만, 젠킨스는 설치형이기 때문에 이를 위한 EC2 인스턴스가 하나 더 필요합니다.     
이제 시작하는 서비스에서 배포를 위한 EC2 인스턴스는 부담스럽기 때문에 오픈소스 웹 서비스인 TravisCI를 사용하겠습니다.     

```     
AWS에서 Travis CI와 같은 CI 도구로 CodeBuild를 제공합니다.   
하지만 빌드 시간만큼 요금이 부과되는 구조라 초기에 사용하기에는 부담스럽습니다.   
실제 서비스되는 EC2, RDS, S3 외에는 비용 부분을 최소화 하는 것이 좋습니다.   
```
   
## 2.1. Travis CI 웹 서비스 설정   
1. https://travis-ci.org/ 에서 깃허브 계정으로 로그인합니다.  
2. 왼쪽 위 [계정명 => Settings]를 클릭합니다.   
3. 이동된 설정 페이지 아래쪽을 보면 깃허브 저장 검색창이 있습니다.   
여기서 저장소 이름을 입력해서 찾은 다음 오른쪽의 상태바를 활성화 시킵니다.  
4. 활성화한 저장소를 클릭하면 저장소 빌드 히스토리 페이지로 이동합니다.   

## 2.2. 프로젝트 설정   
Travis CI의 상세한 설정은 프로젝트에 존재하는 ```.travis.yml``` 파일로 할 수 있습니다.    
그럼 이제부터 ```.travis.yml``` 파일로 Travis CI 설정을 진행해보겠습니다.     

1. ```build.gradle```과 같은 위치에서 ```.travis.yml``` 을 생성합니다.   
2. 아래와 같은 코드를 입력합니다.  

**.travis.yml**
```yml
language: java
jdk:
  - openjdk8
branches:
  only:
    - master

# Travis CI 서버의 Home
cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.gradle'

script: "./gradlew clean build"

# CI 실행 완료 시 메일로 알람
notifications:
  email:
    recipients:
      - kwj1270@naver.com
```
   
___
   
```yml
language: java
jdk:
  - openjdk8
```
서버에서 실행되는 프로그래밍 언어와 해당 jdk 입력   
참고로 우리는 EC2에서 일반 jdk8이 아닌 openjdk8을 다운 받아 사용하므로 이렇게 해준다.   
   
___
   
```yml
branches:
  only:
    - master
```
* Travis CI 를 어느 브랜치가 푸시될 때 수행할지 지정합니다.   
* 현재 옵션은 오직 Master 브랜치에 push 될 때만 수행합니다.
     
___
   
```yml   
# Travis CI 서버의 Home
cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.gradle'
```
* gradle을 통해 의존성을 받게 되면 이를 해당 디렉토리에 캐시하여,       
같은 의존성은 다음 배포 때부터 다시 받지 않도록 설정   

___
   
```yml
script: "./gradlew clean build"
```
* master 브랜치에서 푸시되었을 때 수행하는 명령어입니다.   
* 여기서는 프로젝트 내부에 둔 gradlew 을 통해 clean & build를 수행합니다.   
* 이는 빌드 디렉토리를 삭제하고 다시 빌드한다는 뜻이다.   
    
___ 

```yml
# CI 실행 완료 시 메일로 알람
notifications:
  email:
    recipients:
      - kwj1270@naver.com
```
* Travis CI 실행 완료시 자동으로 알람이 가도록 설정합니다.   
   
___  
  
위 과정까지 진행되었다면 master 브랜치에 커밋과 푸시를 하고,       
좀전의 travis CI 저장소 페이지를 확인합니다.    
빌드가 성공한 것이 확인되면, .travis.yml 에 등록한 이메일을 확인할 수 있습니다.      
빌드가 성공했다면 성공 이메일이 오고 실패했다면 실패 이메일이 도착합니다.     
   
## Travis CI 와 AWS S3 연동하기   
**S3** : AWS에서 제공하는 일종의 **파일 서버**   
이미지 파일을 비롯한 정적 파일들을 관리하거나 지금 진행하는 것처럼 배포 파일들을 관리하는 등의 기능을 지원합니다.   
보통 이미지 업로드를 구현한다면 이 S3를 이용하여 구현하는 경우가 많습니다.     
    
S3를 비롯한 AWS 서비스와 TravisCI를 연동하게 되면 전체 구조는 다음과 같습니다.   
  
[사진]      
   
   
 
 

